<?xml version="1.0" encoding="utf-8"?>

<!--
  BigBlueButton open source conferencing system - http://www.bigbluebutton.org
  
  Copyright (c) 2010 BigBlueButton Inc. and by respective authors (see below).
  
  BigBlueButton is free software; you can redistribute it and/or modify it under the 
  terms of the GNU Lesser General Public License as published by the Free Software 
  Foundation; either version 2.1 of the License, or (at your option) any later 
  version. 
  
  BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY 
  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
  PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
  
  You should have received a copy of the GNU Lesser General Public License along 
  with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
 
  $Id: $
--> 

<mdi:MDIWindow xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:mdi="flexlib.mdi.containers.*" 
	xmlns:flc="flexlib.controls.*"
	implements="org.bigbluebutton.common.IBbbModuleWindow" 
	xmlns:mate="http://mate.asfusion.com/"
	creationComplete="onCreationComplete()"
	title="{ResourceUtil.getInstance().getString('bbb.users.title')}"
	showCloseButton="false">

	<mate:Listener type="{LocaleChangeEvent.LOCALE_CHANGED}" method="localeChanged" />
	<mate:Listener type="{ShortcutEvent.RAISE_HAND}" method="remoteRaiseHand" />
	<mate:Listener type="{ShortcutEvent.FOCUS_USERS_WINDOW}" method="focusWindow" />
	<mate:Listener type="{UsersEvent.ROOM_MUTE_STATE}" method="setRoomMute" />
	<mate:Listener type="{ShortcutEvent.MUTE_ALL_BUT_PRES}" method="remoteMuteAllButPres" />
	<mx:Script>
		<![CDATA[
			import com.asfusion.mate.events.Dispatcher;
			
			import flash.system.Security;
			import flash.system.SecurityPanel;
			
			import mx.binding.utils.BindingUtils;
			import mx.collections.ArrayCollection;
			import mx.controls.Menu;
			import mx.controls.listClasses.IListItemRenderer;
			import mx.events.DataGridEvent;
			import mx.events.ListEvent;
			import mx.events.MenuEvent;
			
			import org.bigbluebutton.common.Images;
			import org.bigbluebutton.common.Role;
			import org.bigbluebutton.common.events.LocaleChangeEvent;
			import org.bigbluebutton.core.managers.UserManager;
			import org.bigbluebutton.main.events.ShortcutEvent;
			import org.bigbluebutton.main.model.users.BBBUser;
			import org.bigbluebutton.main.model.users.Conference;
			import org.bigbluebutton.main.model.users.events.ChangeStatusEvent;
			import org.bigbluebutton.main.model.users.events.KickUserEvent;
			import org.bigbluebutton.main.model.users.events.RoleChangeEvent;
			import org.bigbluebutton.main.views.MainCanvas;
			import org.bigbluebutton.modules.users.events.UsersRollEvent;
			import org.bigbluebutton.core.events.VoiceConfEvent;
			import org.bigbluebutton.modules.users.events.UsersEvent;
			import org.bigbluebutton.modules.users.model.UsersOptions;
			import org.bigbluebutton.util.i18n.ResourceUtil;		
			
			import org.bigbluebutton.common.LogUtil;
			
			private var dispatcher:Dispatcher;
			
			private var keyCombos:Object;
			private var modifier:String;
			
			private var roomMuted:Boolean = false;
			private var myMenu:Menu;
			private var menuStatus:Menu;
			
			[Bindable]
			public var partOptions:UsersOptions;
			
			[Bindable]
			private var images:Images = new Images();
			
			[Bindable]
			private var users:ArrayCollection = new ArrayCollection();
			
			private var amIModerator:Boolean = false;
			
			private const FOCUS_USERS_LIST:String = "Focus Users List";
			private const MAKE_PRESENTER:String = "Make Presenter";
			private const KICK_USER:String = "Kick User";
			private const MUTE_USER:String = "Mute User";
			private const MUTE_ALL_USER:String = "Mute All User";
			
			private var muteMeRolled:Boolean = false;
			
			private var myMenuStaticHeight:Number = 301;

			private function onCreationComplete():void {
				dispatcher = new Dispatcher();
			
				users = UserManager.getInstance().getConference().users;
				amIModerator = UserManager.getInstance().getConference().amIModerator();
				
				settingsBtn.visible = settingsBtn.includeInLayout = partOptions.enableSettingsButton;
				
				BindingUtils.bindSetter(updateNumberofUsers, users, "length");
				
				this.addEventListener(KeyboardEvent.KEY_DOWN, handleKeyDown);
				ResourceUtil.getInstance().addEventListener(Event.CHANGE, localeChanged); // Listen for locale changing
				
				modifier = ExternalInterface.call("determineModifier");
				loadKeyCombos(modifier);
				
				resourcesChanged();
				
				titleBarOverlay.tabIndex = partOptions.baseTabIndex;
				minimizeBtn.tabIndex = partOptions.baseTabIndex+1;
				maximizeRestoreBtn.tabIndex = partOptions.baseTabIndex+2;
				closeBtn.tabIndex = partOptions.baseTabIndex+3;
			}
			
			public function getPrefferedPosition():String{
				return MainCanvas.TOP_LEFT;
			}
			
			
			private function updateNumberofUsers(numUsers:int):void {
				if (numUsers > 8)
					this.title = ResourceUtil.getInstance().getString('bbb.users.title', [":", numUsers]);
				else 
					this.title = ResourceUtil.getInstance().getString('bbb.users.title', ["", ""]);
			}
			
			private function localeChanged(e:Event):void {
				updateNumberofUsers(users.length);
				resourcesChanged();
			}
			
			private function onItemRollOver(event:ListEvent):void{
				var item:IListItemRenderer = event.itemRenderer;
				var user:BBBUser = item.data as BBBUser;
				var rollEvent:UsersRollEvent = new UsersRollEvent(UsersRollEvent.USER_ROLL_OVER, user.userID);
				dispatcher.dispatchEvent(rollEvent);
			}
			
			private function onItemRollOut(event:ListEvent):void{
				var item:IListItemRenderer = event.itemRenderer;
				var user:BBBUser = item.data as BBBUser;
				var rollEvent:UsersRollEvent = new UsersRollEvent(UsersRollEvent.USER_ROLL_OUT, user.userID);
				dispatcher.dispatchEvent(rollEvent);
			}
			
			private function raiseHand():void{
				var e:ChangeStatusEvent;
				var userID:String = UserManager.getInstance().getConference().getMyUserId();
				if (UserManager.getInstance().getConference().getMyMood() == ChangeStatusEvent.RAISE_HAND) {
					e = new ChangeStatusEvent(userID, ChangeStatusEvent.CLEAR_STATUS);
				} else {
					e = new ChangeStatusEvent(userID, ChangeStatusEvent.RAISE_HAND);
				}
				dispatchEvent(e);
			}

			private function clearAllStatus():void {
				for (var i:int = 0; i < users.length; i++) {
					var p:BBBUser = users.getItemAt(i) as BBBUser;
					if (p.hasMood) dispatchEvent( new ChangeStatusEvent(p.userID, ChangeStatusEvent.CLEAR_STATUS) );
				}
			}
			
			private function openSettings():void {
				// everyone can see the audio settings
				var myMenuData:Array = [];

				if(UserManager.getInstance().getConference().amIModerator()) {
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.settings.clearAllStatus'), icon: images.delete_icon, callback: clearAllStatus} );
					if (!roomMuted) {
						myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.settings.muteAll'), icon: images.audio_muted, callback: muteAll} );
						if (UserManager.getInstance().getConference().getPresenter())
							myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.settings.muteAllExcept') + ": " + UserManager.getInstance().getConference().getPresenter().name, icon: images.audio_muted, callback: muteAlmostAll} );
					} else {
						myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.settings.unmuteAll'), icon: images.audio, callback: muteAll} );
					}
				}

				if(partOptions.enableRaiseHand) {
					if (myMenuData.length > 0) {
						myMenuData.push( {type: "separator"} );
					}
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.clearStatus'), icon: images.delete_icon, callback: function():void { changeStatus(ChangeStatusEvent.CLEAR_STATUS); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.raiseHand'), icon: images.hand_new, callback: function():void { changeStatus(ChangeStatusEvent.RAISE_HAND); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.agree'), icon: images.agree, callback: function():void { changeStatus(ChangeStatusEvent.AGREE); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.disagree'), icon: images.disagree, callback: function():void { changeStatus(ChangeStatusEvent.DISAGREE); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.speakLouder'), icon: images.speak_louder, callback: function():void { changeStatus(ChangeStatusEvent.SPEAK_LOUDER); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.speakSofter'), icon: images.speak_lower, callback: function():void { changeStatus(ChangeStatusEvent.SPEAK_LOWER); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.speakFaster'), icon: images.speak_faster, callback: function():void { changeStatus(ChangeStatusEvent.SPEAK_FASTER); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.speakSlower'), icon: images.speak_slower, callback: function():void { changeStatus(ChangeStatusEvent.SPEAK_SLOWER); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.beRightBack'), icon: images.be_right_back, callback: function():void { changeStatus(ChangeStatusEvent.BE_RIGHT_BACK); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.laughter'), icon: images.laughter, callback: function():void { changeStatus(ChangeStatusEvent.LAUGHTER); }} );
					myMenuData.push( {label: ResourceUtil.getInstance().getString('bbb.users.status.sad'), icon: images.sad, callback: function():void { changeStatus(ChangeStatusEvent.SAD); }} );
				}

				// make sure the previous menu is closed before opening a new one
				// This could be improved to include a flag that tells if the menu is open,
				// but it would require an extra listener for the MenuCloseEvent.
				if (myMenu) myMenu.hide();
				
				myMenu = Menu.createMenu(null, myMenuData, true);
				myMenu.variableRowHeight = true;
				var settingsBtnPos:Point = settingsBtn.localToGlobal(new Point(0,0));

				var myMenuPos:Point = new Point();
				myMenuPos.x = settingsBtnPos.x;
				myMenuPos.y = settingsBtnPos.y + settingsBtn.height;
				if (myMenuPos.y + myMenuStaticHeight > stage.stageHeight) {
					myMenuPos.x += settingsBtn.width;
					myMenuPos.y = stage.stageHeight - myMenuStaticHeight;
				}

				myMenu.addEventListener(MenuEvent.ITEM_CLICK, menuClickHandler);
				myMenu.addEventListener(MenuEvent.MENU_SHOW, menuShowHandler);
				myMenu.show(myMenuPos.x, myMenuPos.y);
				myMenu.setFocus();
			}

			private function menuShowHandler(e:MenuEvent):void {
				myMenuStaticHeight = e.currentTarget.height;
				trace("New menu height is " + myMenuStaticHeight);
			}

			private function menuClickHandler(e:MenuEvent):void {
				e.item.callback();
			}

			private function changeStatus(status:String):void {
				var e:ChangeStatusEvent = new ChangeStatusEvent(UserManager.getInstance().getConference().getMyUserId(), status);
				dispatchEvent(e);
			}

			private function setRoomMute(e:UsersEvent):void {
				roomMuted = e.mute_state;
                roomMutedLbl.visible = roomMuted;
			}
			
			private function muteAll():void {
				if (amIModerator) {
					if (!roomMuted) {
						var muteCommand:VoiceConfEvent = new VoiceConfEvent(VoiceConfEvent.MUTE_ALL);
						dispatchEvent(muteCommand);
						roomMuted = true;
					} else {
						var unmuteCommand:VoiceConfEvent = new VoiceConfEvent(VoiceConfEvent.UNMUTE_ALL);
						dispatchEvent(unmuteCommand);
						roomMuted = false;
					}
				}
			}
			
			private function muteAlmostAll():void {
				if (amIModerator) {
					if (!roomMuted) {
						var muteCommand:VoiceConfEvent = new VoiceConfEvent(VoiceConfEvent.MUTE_ALMOST_ALL);
						dispatchEvent(muteCommand);
						roomMuted = true;
					}
				}
			}
			
			override protected function resourcesChanged():void{
				super.resourcesChanged();				
				if (users.length > 8)
					this.title = ResourceUtil.getInstance().getString('bbb.users.title', [":", users.length]);
				else 
					this.title = ResourceUtil.getInstance().getString('bbb.users.title', ["", ""]);
				
				if (titleBarOverlay != null) {
					titleBarOverlay.accessibilityName = ResourceUtil.getInstance().getString('bbb.users.titleBar');
				}
				
				if (windowControls != null) {
					minimizeBtn.toolTip = ResourceUtil.getInstance().getString("bbb.window.minimizeBtn.toolTip");
					minimizeBtn.accessibilityName = ResourceUtil.getInstance().getString("bbb.users.minimizeBtn.accessibilityName");
					
					maximizeRestoreBtn.toolTip = ResourceUtil.getInstance().getString("bbb.window.maximizeRestoreBtn.toolTip");
					maximizeRestoreBtn.accessibilityName = ResourceUtil.getInstance().getString("bbb.users.maximizeRestoreBtn.accessibilityName");
				}
			}
			
			private function loadKeyCombos(modifier:String):void {
				keyCombos = new Object(); // always start with a fresh array bbb.shortcutkey.users.muteall
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.users.focusUsers') as String)] = FOCUS_USERS_LIST;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.users.makePresenter') as String)] = MAKE_PRESENTER;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.users.kick') as String)] = KICK_USER;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.users.mute') as String)] = MUTE_USER;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.users.muteall') as String)] = MUTE_ALL_USER;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.general.maximize') as String)] = ShortcutEvent.MAXIMIZE_USERS;
				keyCombos[modifier+(ResourceUtil.getInstance().getString('bbb.shortcutkey.general.minimize') as String)] = ShortcutEvent.MINIMIZE_USERS;
			}
			
			// Handle general-access hotkeys, regardless of what window the user is focused in
			private function handleKeyDown(e:KeyboardEvent):void {
				if (keyCombos == null) loadKeyCombos(modifier);
				var keyPress:String = (e.ctrlKey  ? "control+" : "") + (e.shiftKey ? "shift+"   : "") +
					(e.altKey   ? "alt+"     : "") + e.keyCode;		                              
				if (keyCombos[keyPress]) {
					switch(keyCombos[keyPress]) {
						case FOCUS_USERS_LIST:
							remoteFocusUsers();
							break;
						case MAKE_PRESENTER:
							remoteMakePresenter();
							break;
						case KICK_USER:
							remoteKickUser();
							break;
						case MUTE_USER:
							remoteMuteUser();
							break;
						case MUTE_ALL_USER:
							muteAll();
							break;
						case ShortcutEvent.MAXIMIZE_USERS:
							remoteMaximize();
							break;
						case ShortcutEvent.MINIMIZE_USERS:
							remoteMinimize();
							break;
					}
				}
			}
			
			private function focusWindow(e:ShortcutEvent):void{
				focusManager.setFocus(titleBarOverlay);
			}
			
			public function remoteRaiseHand(e:ShortcutEvent):void{
				raiseHand();
			}
			
			private function remoteMinimize():void{
				if (!minimized){
					this.minimize();
				}
			}
			
			private function remoteMaximize():void{
				if (!maximized && !minimized){
					this.maximize();
				} else{
					this.restore();
				}				
			}
			
			public function remoteMakePresenter():void{
				if (amIModerator && usersGrid.selectedIndex != -1) {
					var selData:Object = usersGrid.selectedItem;
					
					if (!selData.presenter && !selData.phoneUser) {
						var e:RoleChangeEvent = new RoleChangeEvent(RoleChangeEvent.ASSIGN_PRESENTER);
						e.userid = selData.userID;
						e.username = selData.name;
						dispatchEvent(e);
					}
				}
			}
			
			public function remoteKickUser():void{
				if (amIModerator && usersGrid.selectedIndex != -1 && partOptions.allowKickUser) {
					var selData:Object = usersGrid.selectedItem;
					
					if (!selData.me)
						dispatchEvent(new KickUserEvent(selData.userID));
				}
			}
			
			public function remoteMuteUser():void{
				if (amIModerator && usersGrid.selectedIndex != -1) {
					var selData:Object = usersGrid.selectedItem;
					
					if (selData.voiceJoined) {
						var e:VoiceConfEvent = new VoiceConfEvent(VoiceConfEvent.MUTE_USER);
						e.userid = selData.voiceUserid;
						e.mute = !selData.voiceMuted;
						dispatchEvent(e);
					}
				}
			}
			
			public function remoteFocusUsers():void{
				focusManager.setFocus(usersGrid);
				usersGrid.drawFocus(true);
			}
			
			private function remoteMuteAllButPres():void{
				muteAlmostAll();
			}
			
		]]>
	</mx:Script>
	
	<mx:DataGrid id="usersGrid" dataProvider="{users}" editable="false" sortableColumns="true"
    	dragEnabled="false" width="100%" height="100%" draggableColumns="false"
    	itemRollOver="onItemRollOver(event)"
		itemRollOut="onItemRollOut(event)" 
		tabIndex="{partOptions.baseTabIndex+5}"
		accessibilityName="{ResourceUtil.getInstance().getString('bbb.users.usersGrid.accessibilityName')}" >
    	<mx:columns>
    		<mx:DataGridColumn dataField="userStatus" headerText="{ResourceUtil.getInstance().getString('bbb.users.usersGrid.statusItemRenderer')}" editable="false" width="45" minWidth="45"
    			itemRenderer="org.bigbluebutton.modules.users.views.StatusItemRenderer" sortable="false" />
    		<mx:DataGridColumn dataField="name" headerText="{ResourceUtil.getInstance().getString('bbb.users.usersGrid.nameItemRenderer')}" editable="false" sortable="false" minWidth="60"
    			itemRenderer="org.bigbluebutton.modules.users.views.NameItemRenderer"/>
    		<mx:DataGridColumn dataField="media" headerText="{ResourceUtil.getInstance().getString('bbb.users.usersGrid.mediaItemRenderer')}" sortable="false" width="110" minWidth="110"
    			itemRenderer="org.bigbluebutton.modules.users.views.MediaItemRenderer"/>
    	</mx:columns>
    </mx:DataGrid>
	
	<mx:ControlBar width="100%">
		<mx:Button id="settingsBtn" icon="{images.users_settings}" width="30" height="30"
					toolTip="{ResourceUtil.getInstance().getString('bbb.users.settings.buttonTooltip')}" click="openSettings()" visible="true" tabIndex="{partOptions.baseTabIndex+10}" />
		<mx:Label id="roomMutedLbl" text="{ResourceUtil.getInstance().getString('bbb.users.settings.muteAll')}" />
		<mx:Spacer width="100%"/>
	</mx:ControlBar>
	
</mdi:MDIWindow>
