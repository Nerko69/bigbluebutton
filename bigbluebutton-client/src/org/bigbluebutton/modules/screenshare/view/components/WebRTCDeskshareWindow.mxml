<?xml version="1.0" encoding="utf-8"?>

<!--

BigBlueButton open source conferencing system - http://www.bigbluebutton.org/

Copyright (c) 2015 BigBlueButton Inc. and by respective authors (see below).

This program is free software; you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation; either version 3.0 of the License, or (at your option) any later
version.

BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.

-->

<mx:Box xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:mate="http://mate.asfusion.com/"
	creationComplete="onCreationComplete()"
	styleName="micSettingsWindowStyle">

	<mate:Listener type="{MadePresenterEvent.SWITCH_TO_PRESENTER_MODE}" method="onChangedPresenter"/>
	<mate:Listener type="{MadePresenterEvent.SWITCH_TO_VIEWER_MODE}" method="onChangedPresenter"/>
	<mate:Listener type="{LocaleChangeEvent.LOCALE_CHANGED}" method="localeChanged"/>
	<mate:Listener type="{WebRTCWindowChangeState.DISPLAY_INSTALL}" method="displayInstall"/>
	<mate:Listener type="{WebRTCWindowChangeState.DISPLAY_RETRY}" method="displayRetry"/>
	<mate:Listener type="{WebRTCWindowChangeState.DISPLAY_FALLBACK}" method="displayFallback"/>

	<mx:Script>
		<![CDATA[
			import com.asfusion.mate.events.Dispatcher;
			import flash.external.ExternalInterface;

			import org.as3commons.logging.api.ILogger;
			import org.as3commons.logging.api.getClassLogger;

			import org.bigbluebutton.common.events.LocaleChangeEvent;
			import org.bigbluebutton.main.events.MadePresenterEvent;
			import org.bigbluebutton.modules.screenshare.events.ShareEvent;
			import org.bigbluebutton.modules.screenshare.events.UseJavaModeCommand;
			import org.bigbluebutton.modules.screenshare.events.WebRTCWindowChangeState;
			import org.bigbluebutton.modules.screenshare.model.ScreenshareOptions;
			import org.bigbluebutton.modules.screenshare.events.RequestToStartSharing;
			import org.bigbluebutton.util.i18n.ResourceUtil;

			private static const LOGGER:ILogger = getClassLogger(WebRTCDeskshareWindow);

			private var globalDispatcher:Dispatcher = new Dispatcher();
			private var _screenshareOptions:ScreenshareOptions = null;

			private var _successCallback:Function = null;
			private var _failCallback:Function = null;

			public function get screenshareOptions():ScreenshareOptions {
				if (this._screenshareOptions == null) {
					this._screenshareOptions = new ScreenshareOptions();
					this._screenshareOptions.parseOptions();
				}
				return this._screenshareOptions;
			}

			private function displayInstall(e:Event):void {
				setCurrentState("displayInstall");
			}

			private function displayRetry(e:Event):void {
				setCurrentState("displayRetry");
			}

			private function displayFallback(e:Event):void {
				setCurrentState("displayFallback");
				if (ExternalInterface.available) {
					var isIncognito:Function = function(args:Object):void {
						incognitoLbl.visible = true;
					};

					var isNotIncognito:Function = function(args:Object):void {};

					ExternalInterface.addCallback("isIncognito", isIncognito);
					ExternalInterface.addCallback("isNotIncognito", isNotIncognito);
					ExternalInterface.call("checkIfIncognito", "isIncognito", "isNotIncognito");
				}
			}

			private function onInstallButtonClicked():void {
				navigateToURL(new URLRequest(screenshareOptions.chromeExtensionLink), "_blank");
				globalDispatcher.dispatchEvent(new WebRTCWindowChangeState(WebRTCWindowChangeState.DISPLAY_RETRY));
			}

			private function onRetryButtonClicked():void {
				var onSuccess:Function = function(exists:Boolean):void {
					ExternalInterface.addCallback("onSuccess", null);
					if (exists) {
						globalDispatcher.dispatchEvent(new RequestToStartSharing());
					} else {
						globalDispatcher.dispatchEvent(new WebRTCWindowChangeState(WebRTCWindowChangeState.DISPLAY_FALLBACK));
					}
				};
				ExternalInterface.addCallback("onSuccess", onSuccess);
				ExternalInterface.call("checkChromeExtInstalled", "onSuccess", screenshareOptions.chromeExtensionKey);
			}

			private function onFallbackButtonClicked():void {
				globalDispatcher.dispatchEvent(new UseJavaModeCommand());
				closeWithFail();
			}

			private function onUseWebRTCDeskshareButtonClicked():void {
				btnUseWebRTCDeskshare.enabled = false;
				globalDispatcher.dispatchEvent(new ShareEvent(ShareEvent.START_WEBRTC_SCREENSHARE_EVENT));
			}

			private function onCreationComplete():void {
				setCurrentState("dispFullRegionControlBar");
				resourcesChanged();
			}

			private function onChangedPresenter(e:Event):void {}

			private function localeChanged(e:Event):void {
				resourcesChanged();
			}

			public function set success(callback:Function):void {
				_successCallback = callback;
			}

			public function set fail(callback:Function):void {
				_failCallback = callback;
			}

			private function closeWithSuccess():void {
				if (_successCallback != null) {
					_successCallback();
				}
			}

			private function closeWithFail():void {
				if (_failCallback != null) {
					_failCallback();
				}
			}
		]]>
	</mx:Script>

	<mx:states>
		<mx:State name="dispFullRegionControlBar">
			<mx:AddChild relativeTo="mainElement" position="after">
				<mx:VBox width="100%" height="100%" horizontalAlign="center">
					<mx:Label id="displaySelectionLabel"
							width="70%"
							textAlign="center"
							styleName="micSettingsWindowSpeakIntoMicLabelStyle"
							text="{ResourceUtil.getInstance().getString('bbb.screensharePublish.selection.label')}"/>
					<mx:HBox width="100%" height="100%" horizontalAlign="center">
						<mx:Button id="btnUseWebRTCDeskshare"
								label="{ResourceUtil.getInstance().getString('bbb.screensharePublish.btnUseWebRTCDeskshare.label')}"
								visible="true"
								enabled="true"
								click="onUseWebRTCDeskshareButtonClicked()"/>
						<mx:Button id="btnUseJavaWebStart"
								label="{ResourceUtil.getInstance().getString('bbb.screensharePublish.btnUseJavaWebStart.label')}"
								visible="true"
								enabled="true"
								click="onFallbackButtonClicked()"/>
					</mx:HBox>
				</mx:VBox>
			</mx:AddChild>
		</mx:State>

		<mx:State name="displayInstall">
			<mx:AddChild relativeTo="mainElement" position="after">
				<mx:VBox width="100%" height="100%" horizontalAlign="center">
					<mx:HBox width="100%" horizontalAlign="center">
						<mx:Text id="displayInstallTxt"
								width="100%"
								textAlign="center"
								styleName=""
								text="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCChromeExtensionMissing.label')}"/>
					</mx:HBox>
					<mx:HBox width="100%" horizontalAlign="center">
						<mx:LinkButton id="btnInstallExtension"
								label="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCExtensionInstallButton.label')}"
								visible="true"
								enabled="true"
								styleName="quickWindowLinkStyle"
								click="onInstallButtonClicked()"/>
					</mx:HBox>
				</mx:VBox>
			</mx:AddChild>
		</mx:State>

		<mx:State name="displayRetry">
			<mx:AddChild relativeTo="mainElement" position="after">
				<mx:VBox width="100%" height="100%" horizontalAlign="center">
					<mx:LinkButton id="btnInstallExtension2"
							label="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCExtensionInstallButton.label')}"
							visible="true"
							enabled="true"
							styleName="quickWindowLinkStyle"
							click="onInstallButtonClicked()"/>
					<mx:Label id="displayRetryLabel"
							width="70%"
							textAlign="center"
							styleName=""
							text="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCRetryExtensionInstallation.label')}"/>
					<mx:Button id="btnRetry"
							label="Retry"
							visible="true"
							enabled="true"
							click="onRetryButtonClicked()"/>
				</mx:VBox>
			</mx:AddChild>
		</mx:State>

		<mx:State name="displayFallback">
			<mx:AddChild relativeTo="mainElement" position="after">
				<mx:VBox width="100%" height="100%" horizontalAlign="center">
					<mx:HBox width="100%" height="100%" horizontalAlign="center">
						<mx:Text id="displayFallbackTxt"
								width="100%"
								textAlign="center"
								styleName=""
								text="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCExtensionFailFallback.label')}"/>
					</mx:HBox>
					<mx:HBox width="100%" height="100%" horizontalAlign="center">
						<mx:Text id="incognitoLbl"
								width="100%"
								visible="false"
								text="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCPrivateBrowsingWarning.label')}"/>
					</mx:HBox>
					<mx:HBox width="100%" height="100%" horizontalAlign="center">
						<mx:Button id="btnFallback"
								label="{ResourceUtil.getInstance().getString('bbb.screensharePublish.WebRTCUseJavaButton.label')}"
								visible="true"
								enabled="true"
								click="onFallbackButtonClicked()"/>
					</mx:HBox>
				</mx:VBox>
			</mx:AddChild>
		</mx:State>

  </mx:states>

  <mx:VBox id="mainContainer" width="100%" height="100%"  paddingBottom="2" paddingLeft="2" paddingRight="2" paddingTop="2">
    <mx:HBox width="100%" height="90%" id="mainElement"/>
  </mx:VBox>

</mx:Box>
